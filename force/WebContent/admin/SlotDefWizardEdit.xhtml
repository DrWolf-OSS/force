<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.com/products/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:c="http://java.sun.com/jstl/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:a="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich"
    template="/layout/template.xhtml">

<ui:define name="body">

    <h:form id="slotDef" styleClass="edit">

        <rich:panel>
            <f:facet name="header">#{slotDefHome.managed ? 'Modifica' : 'Creazione'} #{slotDefParameters.model ? 'modello di' : ''} #{slotDefParameters.mode=='PRIMARY' ? 'Busta di Riferimento' : 'Busta Amministrativa'}</f:facet>

            <s:decorate id="templateField" template="/layout/edit.xhtml" rendered="#{not slotDefParameters.model}">
                <ui:define name="label">Modello</ui:define>
               	<h:selectBooleanCheckbox value="#{slotDefHome.instance.template}" />
            </s:decorate>

            <s:decorate id="nameField" template="/layout/edit.xhtml">
                <ui:define name="label">Nome</ui:define>
                <h:inputText id="name" value="#{slotDefHome.instance.name}" required="true"/>
            </s:decorate>
            
            <s:decorate id="typeField" template="/layout/edit.xhtml" rendered="#{slotDefParameters.mode == 'Normal'}">
                <ui:define name="label">Tipo</ui:define>
                <h:selectOneMenu id="slotDefType" value="#{slotDefHome.instance.type}" >
                    	<s:selectItems value="#{slotDefEditBean.slotDefTypes}" 
						var="slotDefType" label="#{slotDefType.value()}"/>
						<s:convertEnum/>
             	</h:selectOneMenu>
            </s:decorate>
			
			<div style="clear:both"/>
			<rich:separator height="25px" lineType="none" rendered="#{slotDefParameters.mode != 'PRIMARY'}"/>
			
			<s:decorate template="/layout/display.xhtml" rendered="#{slotDefParameters.mode != 'PRIMARY'}" id="epropTable">
				<ui:define name="label">
	                <h:outputText value="Informazioni sulla gara" />
				</ui:define>
				<h:outputText value="Nessuna informazione definita" rendered="#{empty slotDefHome.instance.embeddedPropertiesAsList}"/>
				<rich:dataTable value="#{slotDefHome.instance.embeddedPropertiesAsList}" var="eprop" 
						rendered="#{not empty slotDefHome.instance.embeddedPropertiesAsList}" style="width:1024px">
					<rich:column style="width:200px">
						<f:facet name="header">Nome</f:facet>
						<h:outputText value="#{eprop.name}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Tipologia di dato</f:facet>
						<h:outputText value="#{eprop.dataType.value()}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Multipla</f:facet>
						<h:outputText value="#{eprop.multiple ? 'sì' : 'no'}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Valore</f:facet>
						<s:fragment rendered="#{not eprop.multiple}">
							<h:outputText value="#{eprop.stringValue}"
									rendered="#{eprop.dataDefinition.dataType == 'STRING' or eprop.dataDefinition.dataType == 'LINK'}"/>
							<h:outputText value="#{eprop.integerValue}"
									rendered="#{eprop.dataDefinition.dataType == 'INTEGER'}" />
							<h:outputText value="#{eprop.booleanValue ? 'true' : 'false'}"
									rendered="#{eprop.dataDefinition.dataType == 'BOOLEAN'}" />
							<h:outputText value="#{eprop.dateValue}"
									rendered="#{eprop.dataDefinition.dataType == 'DATE'}">
								<s:convertDateTime type="date" dateStyle="short" pattern="dd/MM/yyyy" />
							</h:outputText>
						</s:fragment>
						<s:fragment rendered="#{eprop.multiple}">
							<h:outputText value="#{eprop.value}" />
						</s:fragment>
					</rich:column>
					<rich:column styleClass="action">
						<f:facet name="header">Azioni</f:facet>
		                <a:commandLink value="Modifica" action="#{slotDefEditBean.editEmbeddedProp(eprop)}" 
		            			oncomplete="#{rich:component('embeddedPropPanel')}.show()"
		            			reRender="embeddedPropPanel"/>
		                #{' '}
						<a:commandLink value="Elimina" action="#{slotDefEditBean.removeEmbeddedProp(eprop)}" 
            						disabled="#{slotDefHome.referenced}" reRender="epropTable"/>
					</rich:column>
				</rich:dataTable>
			</s:decorate>
            
            <div style="clear:both"/>
            <rich:separator height="25px" lineType="none" />
            
			<s:decorate template="/layout/display.xhtml" id="propTable">
				<ui:define name="label">
	                <h:outputText value="Informazioni sull'azienda" />
				</ui:define>
				<h:outputText value="Nessuna informazione definita" rendered="#{empty slotDefHome.instance.propertyDefsAsList}"/>
				<rich:dataTable value="#{slotDefHome.instance.propertyDefsAsList}" var="prop" 
						rendered="#{not empty slotDefHome.instance.propertyDefsAsList}" style="width:1024px">
					<rich:column style="width:200px">
						<f:facet name="header">Nome</f:facet>
						<h:outputText value="#{prop.name}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Tipologia di dato</f:facet>
						<h:outputText value="#{prop.dataType.value()}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Obbligatoria</f:facet>
						<h:outputText value="#{prop.required ? 'sì' : 'no'}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Multipla</f:facet>
						<h:outputText value="#{prop.multiple ? 'sì' : 'no'}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Dizionario associato</f:facet>
						<h:outputText value="#{prop.dictionary!=null ? prop.dictionary.name : ''}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Vincolante per le richieste</f:facet>
						<h:outputText value="#{!slotDefEditBean.getReferencedCollectionsNames(prop).equals('') ? slotDefEditBean.getReferencedCollectionsNames(prop) : ''}" />
					</rich:column>
					<rich:column styleClass="action">
						<f:facet name="header">Azioni</f:facet>
		                <a:commandLink value="Modifica" action="#{slotDefEditBean.editProp(prop)}" oncomplete="#{rich:component('propPanel')}.show()" 
		                		        onclick="if(!conf('#{slotDefEditBean.getReferencedCollectionsNames(prop)}')){return false;}"
		                				reRender="propPanel"/>
		                #{' '}
						<a:commandLink value="Elimina" action="#{slotDefEditBean.removeProp(prop)}" 
		                				onclick="if(!conf('#{slotDefEditBean.getReferencedCollectionsNames(prop)}')){return false;}"
		                				disabled="#{slotDefHome.referenced}" reRender="propTable,collTable"/>
					</rich:column>
				</rich:dataTable>
			</s:decorate>
			
			<div style="clear:both"/>
			<rich:separator height="25px" lineType="none" />
			
			<s:decorate template="/layout/display.xhtml" id="collTable">
				<ui:define name="label">
	                <h:outputText value="Richieste" />
				</ui:define>
				<h:outputText value="Nessuna richiesta definita" rendered="#{empty slotDefHome.instance.docDefCollectionsAsList}"/>
				<rich:dataTable value="#{slotDefHome.instance.docDefCollectionsAsList}" var="coll" 
						rendered="#{not empty slotDefHome.instance.docDefCollectionsAsList}" style="width:1024px">
					<rich:column style="width:200px">
						<f:facet name="header">Nome</f:facet>
						<h:outputText value="#{coll.name}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Tipo di documento</f:facet>
						<h:outputText value="#{coll.docDef.name}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Quantità</f:facet>
						<h:outputText value="#{coll.quantifier.value()}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Informazione vincolante</f:facet>
						<h:outputText value="#{coll.conditionalPropertyDef!=null ? coll.conditionalPropertyDef.name : ''}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Valore informazione vincolante</f:facet>
						<h:outputText value="#{coll.conditionalPropertyInst.stringValue}"
								rendered="#{coll.conditionalPropertyInst.dataDefinition.dataType == 'STRING' or dataInstance.dataDefinition.dataType == 'LINK'}"/>
						<h:outputText value="#{coll.conditionalPropertyInst.integerValue}"
								rendered="#{coll.conditionalPropertyInst.dataDefinition.dataType == 'INTEGER'}" />
						<h:outputText value="#{coll.conditionalPropertyInst.booleanValue ? 'true' : 'false'}"
								rendered="#{coll.conditionalPropertyInst.dataDefinition.dataType == 'BOOLEAN'}" />
						<h:outputText value="#{coll.conditionalPropertyInst.dateValue}"
								rendered="#{coll.conditionalPropertyInst.dataDefinition.dataType == 'DATE'}">
							<s:convertDateTime type="date" dateStyle="short" pattern="dd/MM/yyyy" />
						</h:outputText>
					</rich:column>
					<rich:column styleClass="action">
						<f:facet name="header">Azioni</f:facet>
	                		<a:commandLink value="Modifica" action="#{slotDefEditBean.editColl(coll)}" oncomplete="#{rich:component('collPanel')}.show()" reRender="collPanel"/>
							#{'  '}
							<a:commandLink value="Elimina" action="#{slotDefEditBean.removeColl(coll)}" 
									disabled="#{slotDefHome.referenced}" reRender="collTable"/>
					</rich:column>
				</rich:dataTable>
			</s:decorate>
			
			
			<div style="clear:both"/>
			<rich:separator height="15px" lineType="none" />
			
			
			<s:decorate template="/layout/display.xhtml">
				<ui:define name="label">
	                <h:outputText value="" />
				</ui:define>
				<a:commandButton value="Aggiungi informazione #{slotDefParameters.mode == 'PRIMARY' ? 'sull azienda' : ''}" 
							onclick="if(#{slotDefHome.referenced}){if(!confirm('Lo Slot ha già istanze collegate, sicuri di volerlo modificare?')){return false;}}" 
							action="#{slotDefEditBean.newProperty()}" oncomplete="#{rich:component('propPanel')}.show()" reRender="pf,propPanel" rendered="#{slotDefParameters.mode != 'GENERAL'}"/>
				<a:commandButton value="Aggiungi richiesta" onclick="if(#{slotDefHome.referenced}){if(!confirm('Lo Slot ha già istanze collegate, sicuri di volerlo modificare?')){return false;}}" 
							action="#{slotDefEditBean.newCollection()}" oncomplete="#{rich:component('collTypePanel')}.show()" reRender="collPanel"/>
				<a:commandButton value="Aggiungi informazioni relative alla gara" action="#{slotDefEditBean.newEmbeddedProperty()}" 
							oncomplete="#{rich:component('embeddedPropPanel')}.show()" reRender="embeddedPropPanel" rendered="#{slotDefParameters.mode != 'PRIMARY'}"/>
			</s:decorate>
			
            <div style="clear:both">
            </div>

        </rich:panel>

        <div class="actionButtons">
        
        	<h:commandButton id="assign"
                          value="Associa alla gara"
                         action="#{slotDefEditBean.persistAssosiation()}"
                       disabled="#{!slotDefHome.wired}"
                       rendered="#{garaHome.garaId != null}"/>

            <h:commandButton id="save"
                          value="Salva"
                         action="#{slotDefEditBean.save()}"
                       disabled="#{!slotDefHome.wired}"
                       rendered="#{!slotDefHome.managed}"/>

            <h:commandButton id="update"
                          value="Aggiorna"
                         action="#{slotDefEditBean.update()}"
                       rendered="#{slotDefHome.managed}"/>

            <h:commandButton id="delete"
                          value="Elimina"
                         action="#{slotDefHome.remove}"
                      immediate="true"
                       rendered="#{slotDefHome.managed}"/>

            <s:button id="cancelEdit"
                   value="Annulla"
             propagation="end"
                    view="/#{empty from ? 'SlotDefList.xhtml' : from}"
                rendered="#{slotDefHome.managed}">
                <f:param name="mode" value="#{slotDefParameters.mode}"/>
                <f:param name="model" value="#{slotDefParameters.model}"/>
            </s:button>

            <s:button id="cancelAdd"
                   value="Annulla"
             propagation="end"
                    view="/#{empty from ? 'SlotDefList.xhtml' : from}"
                rendered="#{!slotDefHome.managed}">
                <f:param name="mode" value="#{slotDefParameters.mode}"/>
                <f:param name="model" value="#{slotDefParameters.model}"/>
            </s:button>

        </div>

    </h:form>
    
       <rich:modalPanel id="collTypePanel" autosized="true" minWidth="500"
				resizeable="false">
			<f:facet name="header">
				<h:outputText value="Scegli la tipologia di richiesta" />
			</f:facet>
			<a:form id="ctpf">
			<s:div style="text-align: center">
				<a:commandButton action="#{slotDefEditBean.setConditional(false)}" oncomplete="#{rich:component('collTypePanel')}.hide(); #{rich:component('collPanel')}.show();"
								value="Aggiungi richiesta comune" reRender="collPanel,propPanel"/>
				#{' '}
				<a:commandButton action="#{slotDefEditBean.newConditionaProperty()}" oncomplete="#{rich:component('collTypePanel')}.hide(); #{rich:component('propPanel')}.show();"
								value="Aggiungi richiesta vincolata" reRender="pf,collPanel,propPanel"/>
	        <div style="clear:both"/>
	        </s:div>
	        <a:region>
			<a:commandButton value="Annulla" oncomplete="#{rich:component('collTypePanel')}.hide()" reRender="pf,propPanel,collPanel"/>
			</a:region>
			</a:form>
		</rich:modalPanel>
    

       <rich:modalPanel id="propPanel" autosized="true" minWidth="600"
				resizeable="false">
			<f:facet name="header">
				<h:outputText value="Add Property" />
			</f:facet>
			<a:form id="pf">
				<script type="text/javascript">
					var pinvalid = false;
				</script>
				<ui:param name="customType" value="p" />
				<ui:param name="prefix" value="p" />
			<s:div>
	            <a:region>
				<s:decorate template="/layout/edit.xhtml">
	                <ui:define name="label">
	                	<h:outputText value="Nome dell'informazione"/>
					</ui:define>
					<h:inputText value="#{slotDefEditBean.propertyDef.name}" required="true" styleClass="ptext"/>
	            </s:decorate>
	            
	            <s:decorate template="/layout/edit.xhtml">
	                <ui:define name="label">
	                	<h:outputText value="Tipologia del dato" />
					</ui:define>
					<h:selectOneMenu id="pDataType" value="#{slotDefEditBean.propertyDef.dataType}" required="true">
                    	<s:selectItems value="#{dataTypes}" var="type" label="#{type.value()}" noSelectionLabel="-- seleziona un tipo --"/>
					<a:support event="onchange" reRender="pf"/>
             		</h:selectOneMenu>
	            </s:decorate>
	            
	            <s:decorate template="/layout/edit.xhtml">
	                <ui:define name="label">
	                	<h:outputText value="Informazione obbligatoria" />
					</ui:define>
					<h:selectBooleanCheckbox value="#{slotDefEditBean.propertyDef.required}" />
	            </s:decorate>

	            
	            <s:decorate template="/layout/edit.xhtml" rendered="#{slotDefEditBean.propertyDef.dataType != 'BOOLEAN' and not slotDefEditBean.conditional}">
	                <ui:define name="label">
	                	<h:outputText value="Accetta valori multipli" />
					</ui:define>
					<h:selectBooleanCheckbox value="#{slotDefEditBean.propertyDef.multiple}" >
						<a:support event="onchange" reRender="pf"/>
					</h:selectBooleanCheckbox>
	            </s:decorate>
					</a:region>
	            
	            <s:decorate id="dictionary" template="/layout/edit.xhtml" rendered="#{slotDefEditBean.propertyDef.dataType != 'BOOLEAN'}">
	                <ui:define name="label">
	                	<h:outputText value="Dizionario associato" />
					</ui:define>
					<h:selectOneMenu value="#{slotDefEditBean.propertyDef.dictionary}" required="#{slotDefEditBean.propertyDef.multiple or slotDefEditBean.conditional}">
                    		<s:selectItems value="#{dictionayListManager.retrieveByType(slotDefEditBean.propertyDef.dataType)}" 
											var="dictionary" label="#{dictionary.name}" noSelectionLabel="-- seleziona un dizionario --"/>
							<s:convertEntity/>
             		</h:selectOneMenu>
	            </s:decorate>
	        </s:div>
	        <div style="clear:both"/>
			<a:commandButton value="Ok" action="#{slotDefEditBean.addProperty()}" oncomplete="if(!pinvalid){#{rich:component('propPanel')}.hide();}" 
							rendered="#{not (slotDefEditBean.conditional and slotDefParameters.wizard and not slotDefEditBean.edit)}"	reRender="pf,slotDef,condPD"/>
			<a:commandButton value="Ok" action="#{slotDefEditBean.addConditionalProperty()}" oncomplete="if(!pinvalid){#{rich:component('propPanel')}.hide();#{rich:component('collPanel')}.show();}" 
							rendered="#{slotDefEditBean.conditional and slotDefParameters.wizard and not slotDefEditBean.edit}"	reRender="slotDef,cpf,pf"/>
			<a:region>
			<a:commandButton value="Annulla" action="#{slotDefEditBean.clearEditing()}" oncomplete="#{rich:component('propPanel')}.hide()" reRender="pf,propPanel,collPanel"/>
			</a:region>
			<a:commandButton value="Aggiorna" styleClass="rightCommand" reRender="pf"/>
			</a:form>
		</rich:modalPanel>
		

		<rich:modalPanel id="embeddedPropPanel" autosized="true" minWidth="600"
				resizeable="false">
			<f:facet name="header">
				<h:outputText value="Add Embedded Property" />
			</f:facet>
			<a:form id="epForm">
				<script type="text/javascript">
					var epinvalid = false;
				</script>
				<ui:param name="customType" value="p" />
				<ui:param name="prefix" value="ep" />
			<s:div id="embeddedPropValue">
			<a:region>
				<s:decorate template="/layout/edit.xhtml">
	                <ui:define name="label">
	                	<h:outputText value="Nome dell'informazione" styleClass="ptext"/>
					</ui:define>
					<h:inputText value="#{slotDefEditBean.embeddedProperty.name}" required="true"/>
	            </s:decorate>

	            <s:decorate template="/layout/edit.xhtml">
	                <ui:define name="label">
	                	<h:outputText value="Tipologia del dato" />
					</ui:define>
					<h:selectOneMenu id="pDataType" value="#{slotDefEditBean.embeddedProperty.dataType}" required="true">
                    	<s:selectItems value="#{dataTypes}" var="type" label="#{type.value()}"
							noSelectionLabel="-- seleziona un tipo --"/>
						<s:convertEnum/>
					<a:support event="onchange" action="#{slotDefEditBean.embeddedPropertyListener}" reRender="epForm"/>
             		</h:selectOneMenu>
	            </s:decorate>
	            
	            <s:decorate template="/layout/edit.xhtml" rendered="#{slotDefEditBean.embeddedProperty.dataType != 'BOOLEAN'}">
	                <ui:define name="label">
	                	<h:outputText value="Accetta valori multipli" />
					</ui:define>
					<h:selectBooleanCheckbox value="#{slotDefEditBean.embeddedProperty.multiple}" >
						<a:support event="onchange" action="#{slotDefEditBean.embeddedProperty.clean}" reRender="epForm"/>
					</h:selectBooleanCheckbox>
	            </s:decorate>
	            </a:region>
				
				<a:region>
	            <s:decorate id="dictionary" template="/layout/edit.xhtml" rendered="#{slotDefEditBean.embeddedProperty.dataType != 'BOOLEAN'}">
	                <ui:define name="label">
	                	<h:outputText value="Dizionario associato" />
					</ui:define>
					<h:selectOneMenu value="#{slotDefEditBean.embeddedProperty.dictionary}" required="#{slotDefEditBean.embeddedProperty.multiple}">
                    		<s:selectItems value="#{dictionayListManager.retrieveByType(slotDefEditBean.embeddedProperty.dataType)}" 
											var="dictionary" label="#{dictionary.name}" noSelectionLabel="-- seleziona un dizionario --"/>
							<s:convertEntity/>
					<a:support event="onchange" action="#{slotDefEditBean.embeddedProperty.clean}" reRender="epForm"/>
             		</h:selectOneMenu>
	            </s:decorate>
	            </a:region>
	            
	            <s:div rendered="#{slotDefEditBean.embeddedProperty.dataType != null}">
		            <s:decorate template="/layout/edit.xhtml">
		                <ui:define name="label">
		                	<h:outputText value="Valore" />
						</ui:define>
							
							<s:fragment rendered="#{not slotDefEditBean.embeddedProperty.multiple}">
							<h:inputText value="#{slotDefEditBean.embeddedProperty.stringValue}"
								rendered="#{(slotDefEditBean.embeddedProperty.dataDefinition.dataType == 'STRING' or slotDefEditBean.embeddedProperty.dataDefinition.dataType == 'LINK') and slotDefEditBean.embeddedProperty.dataDefinition.dictionaryValues == null}"
								required="true"
								disabled="#{not slotDefEditBean.embeddedProperty.dataDefinition.editable}" />
							<h:inputText value="#{slotDefEditBean.embeddedProperty.integerValue}"
								rendered="#{slotDefEditBean.embeddedProperty.dataDefinition.dataType == 'INTEGER' and slotDefEditBean.embeddedProperty.dataDefinition.dictionaryValues == null}"
								required="true"
								disabled="#{not slotDefEditBean.embeddedProperty.dataDefinition.editable}" />
							<a:region>
							<h:selectBooleanCheckbox value="#{slotDefEditBean.embeddedProperty.booleanValue}"
								rendered="#{slotDefEditBean.embeddedProperty.dataDefinition.dataType == 'BOOLEAN'}"
								required="true"
								disabled="#{not slotDefEditBean.embeddedProperty.dataDefinition.editable}">
							</h:selectBooleanCheckbox>
							</a:region>
							<rich:calendar id="subscriptionDate" mode="client"
								value="#{slotDefEditBean.embeddedProperty.dateValue}" datePattern="dd/MM/yyyy"
								rendered="#{slotDefEditBean.embeddedProperty.dataDefinition.dataType == 'DATE' and slotDefEditBean.embeddedProperty.dataDefinition.dictionaryValues == null}"
								required="true"
								disabled="#{not slotDefEditBean.embeddedProperty.dataDefinition.editable}" />
							
							<h:selectOneMenu value="#{slotDefEditBean.embeddedProperty.stringValue}" required="true"
										rendered="#{slotDefEditBean.embeddedProperty.dataDefinition.dataType == 'STRING' and slotDefEditBean.embeddedProperty.dataDefinition.dictionaryValues != null}"
										valueChangeListener="#{valueChangeListener.listener}">
	                    		<s:selectItems value="#{slotDefEditBean.embeddedProperty.dataDefinition.dictionaryValues}" 
												var="value" label="#{value}" noSelectionLabel="-- select a value --"/>
	             			</h:selectOneMenu>
	             			<h:selectOneMenu value="#{slotDefEditBean.embeddedProperty.integerValue}" required="true"
	             						rendered="#{slotDefEditBean.embeddedProperty.dataDefinition.dataType == 'INTEGER' and slotDefEditBean.embeddedProperty.dataDefinition.dictionaryValues != null}"
	             						valueChangeListener="#{valueChangeListener.listener}">
	                    		<s:selectItems value="#{slotDefEditBean.embeddedProperty.dataDefinition.dictionaryValues}" 
												var="value" label="#{value}" noSelectionLabel="-- select a value --"/>
	             			</h:selectOneMenu>
	             			<h:selectOneMenu value="#{slotDefEditBean.embeddedProperty.dateValue}"  required="true"
	             						rendered="#{slotDefEditBean.embeddedProperty.dataDefinition.dataType == 'DATE' and slotDefEditBean.embeddedProperty.dataDefinition.dictionaryValues != null}"
	             						valueChangeListener="#{valueChangeListener.listener}">
	                    		<s:selectItems value="#{slotDefEditBean.embeddedProperty.dataDefinition.dictionaryValues}" 
												var="value" label="#{value}" noSelectionLabel="-- select a value --"/>
								<s:convertDateTime type="date" dateStyle="short" pattern="dd/MM/yyyy" />
	             			</h:selectOneMenu>
	             			</s:fragment>
	             			
	             			<s:fragment rendered="#{slotDefEditBean.embeddedProperty.multiple and slotDefEditBean.embeddedProperty.dictionary != null}">
	             			<rich:pickList value="#{slotDefEditBean.embeddedProperty.valuesAsList}" required="true">
								<s:selectItems value="#{slotDefEditBean.embeddedProperty.dataDefinition.dictionaryValues}" var="value" label="#{value}" />
							</rich:pickList>
							</s:fragment>
		            </s:decorate>
	            </s:div>
	        </s:div>
	        <div style="clear:both"/>
			<a:commandButton value="Ok" action="#{slotDefEditBean.addEmbeddedProperty()}" oncomplete="if(!epinvalid){#{rich:component('embeddedPropPanel')}.hide();}" reRender="epForm,slotDef"/>
			<a:region>
			<a:commandButton value="Annulla" onclick="#{rich:component('embeddedPropPanel')}.hide()"/>
			</a:region>
			<a:commandButton value="Aggiorna" styleClass="rightCommand" reRender="epForm"/>
			</a:form>
		</rich:modalPanel>
		
		<!-- TODO: Per controllare il form uso la variabile invalid invece di cpfinvalid che non viene valorizzata.. -->
		<rich:modalPanel id="collPanel" autosized="true" minWidth="600"
				resizeable="false">
			<f:facet name="header">
				<h:outputText value="Descrizione della Richiesta" />
			</f:facet>
			<a:form id="cpf">
				<script type="text/javascript">
					var cinvalid = false;
				</script>
				<ui:param name="customType" value="p" />
				<ui:param name="prefix" value="c" />
			<s:div>
			<a:region>
				<s:decorate template="/layout/edit.xhtml">
	                <ui:define name="label">
	                	<h:outputText value="Nome della Richiesta" rendered="#{not slotDefEditBean.conditional}"/>
	                	<h:outputText value="Nome della Richiesta Vincolata" rendered="#{slotDefEditBean.conditional}"/>
					</ui:define>
					<h:inputText value="#{slotDefEditBean.collection.name}" required="true" styleClass="ptext"/>
	            </s:decorate>
	            
	            <s:fragment rendered="false">
	            <s:decorate template="/layout/edit.xhtml">
	                <ui:define name="label">
	                	<h:outputText value="Min" />
					</ui:define>
					<h:inputText value="#{slotDefEditBean.collection.min}" />
	            </s:decorate>
	            <s:decorate template="/layout/edit.xhtml">
	                <ui:define name="label">
	                	<h:outputText value="Max" />
					</ui:define>
					<h:inputText value="#{slotDefEditBean.collection.max}" />
	            </s:decorate>
	            </s:fragment>
	            
	            <s:decorate template="/layout/edit.xhtml">
	                <ui:define name="label">
	                	<h:outputText value="Tipo di documento" />
					</ui:define>
					<h:selectOneMenu id="cDocDef" value="#{slotDefEditBean.collection.docDef}" required="true">
                    	<s:selectItems value="#{docDefList.resultList}" 
						var="docDef" label="#{docDef.name}" noSelectionLabel="-- seleziona una tipologia di documento --"/>
						<s:convertEntity/>
             		</h:selectOneMenu>
	            </s:decorate>
	            <s:decorate template="/layout/edit.xhtml" rendered="#{slotDefEditBean.conditional}" id="condPD">
	                <ui:define name="label">
	                	<h:outputText value="Informazione vincolante" />
					</ui:define>
					<h:selectOneMenu  value="#{slotDefEditBean.collection.conditionalPropertyDef}" converter="propertyDefConverter" disabled="#{slotDefEditBean.conditional}">
     					<s:selectItems value="#{slotDefHome.instance.propertyDefsAsList}" label="#{propertyDef.name}"
									var="propertyDef"  noSelectionLabel="-- select a value --" itemLabel="#{propertyDef.id}" itemValue="#{propertyDef.id}:#{propertyDef.uuid}" 
									disabled="#{(not propertyDef.multiple) and (propertyDef.dictionary == null) and (propertyDef.dataType != 'BOOLEAN')}"/>
						<a:support event="onchange" actionListener="#{slotDefEditBean.conditionalPropertyListener}" reRender="cpf"/>
					</h:selectOneMenu>
	            </s:decorate>
				</a:region>
				
					
	            <s:decorate  template="/layout/edit.xhtml" rendered="#{slotDefEditBean.collection.conditionalPropertyDef != null}" id="condPI">	            	
	                <ui:define name="label">
	                	<h:outputText value="Valore vincolante" />
					</ui:define>
					<h:inputText value="#{slotDefEditBean.collection.conditionalPropertyInst.stringValue}"
							rendered="#{slotDefEditBean.collection.conditionalPropertyDef.dataType == 'STRING' and slotDefEditBean.collection.conditionalPropertyDef.dictionaryValues == null}"
							required="#{slotDefEditBean.collection.conditionalPropertyDef != null}"/>
						<h:inputText value="#{slotDefEditBean.collection.conditionalPropertyInst.integerValue}"
							rendered="#{slotDefEditBean.collection.conditionalPropertyDef.dataType == 'INTEGER' and slotDefEditBean.collection.conditionalPropertyDef.dictionaryValues == null}"
							required="#{slotDefEditBean.collection.conditionalPropertyDef != null}"/>
						<h:selectBooleanCheckbox value="#{slotDefEditBean.collection.conditionalPropertyInst.booleanValue}"
							rendered="#{slotDefEditBean.collection.conditionalPropertyDef.dataType == 'BOOLEAN'}"
							required="#{slotDefEditBean.collection.conditionalPropertyDef != null}"/>
						<rich:calendar id="subscriptionDate" mode="client"
							value="#{slotDefEditBean.collection.conditionalPropertyInst.dateValue}" datePattern="dd/MM/yyyy"
							rendered="#{slotDefEditBean.collection.conditionalPropertyDef.dataType == 'DATE' and slotDefEditBean.collection.conditionalPropertyDef.dictionaryValues == null}"
							required="#{slotDefEditBean.collection.conditionalPropertyDef != null}"/>
							
						
						<h:selectOneMenu value="#{slotDefEditBean.collection.conditionalPropertyInst.stringValue}" required="#{slotDefEditBean.collection.conditionalPropertyDef != null}"
									rendered="#{slotDefEditBean.collection.conditionalPropertyDef.dataType == 'STRING' and slotDefEditBean.collection.conditionalPropertyDef.dictionaryValues != null}">
                    		<s:selectItems value="#{slotDefEditBean.collection.conditionalPropertyDef.dictionaryValues}" 
											var="value" label="#{value}" noSelectionLabel="-- select a value --"/>
             			</h:selectOneMenu>
             			<h:selectOneMenu value="#{slotDefEditBean.collection.conditionalPropertyInst.integerValue}" required="#{slotDefEditBean.collection.conditionalPropertyDef != null}"
									rendered="#{slotDefEditBean.collection.conditionalPropertyDef.dataType == 'INTEGER' and slotDefEditBean.collection.conditionalPropertyDef.dictionaryValues != null}">
                    		<s:selectItems value="#{slotDefEditBean.collection.conditionalPropertyDef.dictionaryValues}" 
											var="value" label="#{value}" noSelectionLabel="-- select a value --"/>
             			</h:selectOneMenu>
             			<h:selectOneMenu value="#{slotDefEditBean.collection.conditionalPropertyInst.dateValue}"  required="#{slotDefEditBean.collection.conditionalPropertyDef != null}"
             						rendered="#{slotDefEditBean.collection.conditionalPropertyDef.dataType == 'DATE' and slotDefEditBean.collection.conditionalPropertyDef.dictionaryValues != null}">
                    		<s:selectItems value="#{slotDefEditBean.collection.conditionalPropertyDef.dictionaryValues}" 
											var="value" label="#{value}" noSelectionLabel="-- select a value --"/>
							<s:convertDateTime type="date" dateStyle="short" pattern="dd/MM/yyyy" />
             			</h:selectOneMenu>
	            </s:decorate>
	            
	            <s:decorate id="quantifier" template="/layout/edit.xhtml">
                	<ui:define name="label">Quantità</ui:define>
               		<h:selectOneMenu value="#{slotDefEditBean.collection.quantifier}" required="true">
                    	<s:selectItems value="#{quantifierTypes}" noSelectionLabel="-- seleziona una quantità --" 
							var="quantifierType" label="#{quantifierType.value()}"/>
						<s:convertEnum/>
             		</h:selectOneMenu>
            	</s:decorate>
	        </s:div>
	        <div style="clear:both"/>
			<a:commandButton value="Ok" action="#{slotDefEditBean.addConditionedCollection()}" oncomplete="if(!cinvalid){#{rich:component('collPanel')}.hide();}" reRender="cpf,pf,collTable,propTable,propPanel"/>
			<a:region>
			<a:commandButton value="Annulla" action="#{slotDefEditBean.clearEditing()}" oncomplete="#{rich:component('collPanel')}.hide()" reRender="cpf"/>
			</a:region>
			<a:commandButton value="Aggiorna" styleClass="rightCommand" reRender="cpf"/>
			</a:form>
		</rich:modalPanel>
		
		<script type="text/javascript">
		function conf(c){
			if(c!=''){
				if(!confirm('L\'informazione è condizionale per le richieste: "'+c+'".\nSicuro di voler continuare?')){
					return false;
				}else{
					return true;
				}
			}
			return true;
		}
		</script>
		
</ui:define>

</ui:composition>
